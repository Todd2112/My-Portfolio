# merge_vector.py: Vectorization & FAISS Index Service

`merge_vector.py` is **Phase 2** of the AI-Train pipeline. It converts cleaned, structured documents from Phase 1 into a **persistent, searchable vector index** using a locked local embedding model and FAISS.

This service is responsible for **embedding generation, deterministic outlier filtering, index construction, metadata preservation, and semantic retrieval**. It runs as a local Flask API and never sends data to external services.

**Core Principle:** Vectorization should be deterministic, metadata-safe, and local. Embeddings are infrastructure, not an opaque black box.

---

## What It Does

`merge_vector.py` transforms Phase 1 JSONL output into a production-ready vector knowledge base:

- **Ingests JSONL** generated by `ai-train.py`
- **Preserves all document metadata** (source, category, summary, token counts)
- **Generates embeddings locally** using a locked SentenceTransformer model
- **Detects and removes statistical outliers** deterministically
- **Builds FAISS indexes** for fast semantic similarity search
- **Versions all artifacts** (indexes and metadata) with timestamps
- **Exposes a search API** for downstream reasoning layers

All processing is local. No cloud APIs. No model downloads at runtime. No hidden state.

---

## Why This Exists

Most vector pipelines fail in three predictable ways:

**Metadata Loss**  
Documents are embedded, but their provenance is discarded. Search results return text fragments without context, source, or explanation.

**Non-Deterministic Indexing**  
Embeddings are filtered heuristically or incrementally, leading to unstable index geometry and irreproducible results.

**Model Drift**  
Indexes are queried with different embedding models or dimensions than they were built with, silently degrading retrieval quality.

`merge_vector.py` eliminates all three:

- **Metadata integrity:** Full Phase 1 metadata is persisted alongside every embedding
- **Deterministic construction:** All embeddings are computed before filtering
- **Strict validation:** Query-time checks enforce model and dimension consistency

---

## Position in the AI-Train Pipeline

```text
Phase 1: ai-train.py
  └─ Crawl → Clean → Classify → Chunk → Summarize → JSONL

Phase 2: merge_vector.py  ← (this service)
  └─ Embed → Filter → Index → Persist → Search

Phase 3: ask_ai / reasoning layer
  └─ Retrieve → Rank → Synthesize
